{% extends 'base.html' %}

{% block title %}VFORUM - Comunidad EEVI{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/forum_interactive.css') }}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="forum-container">
    <header class="forum-header">
        <h1 class="forum-title">VFORUM</h1>
        <p class="forum-subtitle">Comunidad de creadores audiovisuales</p>
    </header>

    <!-- Bot√≥n Nuevo Tema -->
    <button class="new-topic-btn" id="newTopicBtn">
        <span>‚úèÔ∏è</span>
        Nuevo Tema
    </button>

    <!-- Formulario Nuevo Tema -->
    <div class="new-topic-form" id="newTopicForm">
        <form id="topicForm" action="{{ url_for('forum_new') }}" method="post">
            <div class="form-group">
                <label class="form-label" for="authorName">Nombre:</label>
                <input type="text" id="authorName" name="autor" class="form-input" required>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="category">Categor√≠a:</label>
                <select id="category" name="category" class="form-select" required>
                    <option value="">Selecciona una categor√≠a</option>
                    {% for category in categories %}
                    <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="title">T√≠tulo:</label>
                <input type="text" id="title" name="titulo" class="form-input" required>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="content">Contenido:</label>
                <textarea id="content" name="contenido" class="form-textarea" placeholder="Escribe tus dudas o comparte tu conocimiento con la comunidad..." required></textarea>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelBtn">Cancelar</button>
                <button type="submit" class="btn btn-primary">Publicar</button>
            </div>
        </form>
    </div>

    <!-- Lista de Topics -->
    <div class="topics-list" id="topicsList">
        {% for topic in temas %}
        <div class="topic-card {{ 'owned' if topic.author == session.get('current_user') else '' }}" data-topic-id="{{ topic.id }}">
            <div class="topic-header">
                <div class="topic-avatar">{{ topic.author[0].upper() if topic.author else 'A' }}</div>
                <div class="topic-info">
                    <h3 class="topic-title">{{ topic.titulo }}</h3>
                    <div class="topic-meta">
                        {% if topic.category %}
                        <span class="topic-category">
                            {% if 'Grabaci√≥n' in topic.category %}üé§
                            {% elif 'Dise√±o' in topic.category %}üé®
                            {% elif 'Foley' in topic.category %}üîä
                            {% elif 'v√≠deo' in topic.category %}üé¨
                            {% elif 'audio' in topic.category and 'Edici√≥n' in topic.category %}üéß
                            {% elif 'Mezcla' in topic.category %}‚ö°
                            {% elif 'Micr√≥fonos' in topic.category %}üéôÔ∏è
                            {% elif 'Workflows' in topic.category %}üîß
                            {% elif 'Ambientes' in topic.category %}üå≤
                            {% elif 'Postproducci√≥n' in topic.category %}üéûÔ∏è
                            {% elif 'Formatos' in topic.category %}üìÑ
                            {% elif 'Consejos' in topic.category %}üí°
                            {% else %}üéµ{% endif %}
                            {{ topic.category }}
                        </span>
                        <span>‚Ä¢</span>
                        {% endif %}
                        <span>Por {{ topic.author or 'An√≥nimo' }}</span>
                        <span>‚Ä¢</span>
                        <span>{{ topic.timestamp|time_ago if topic.timestamp else 'Hace un momento' }}</span>
                    </div>
                </div>
                <div class="topic-stats">
                    <div class="stat-item">
                        <span>üí¨</span>
                        <span id="responses-count-{{ topic.id }}">0</span>
                    </div>
                    <div class="stat-item">
                        <span>üëÅÔ∏è</span>
                        <span>{{ (topic.votes or 0) * 10 + 20 }}</span>
                    </div>
                </div>
            </div>
            <div class="topic-content">{{ topic.contenido }}</div>
            {% if topic.author == session.get('current_user') %}
            <button class="delete-btn" onclick="deleteTopic('{{ topic.id }}')">üóëÔ∏è</button>
            {% endif %}
            
            <!-- Topic Detail (Expandido) -->
            <div class="topic-detail" id="detail-{{ topic.id }}">
                <div class="responses-section">
                    <h4 class="responses-title">Respuestas (<span id="responses-title-count-{{ topic.id }}">0</span>)</h4>
                    <div id="responses-{{ topic.id }}">
                        <!-- Las respuestas se cargan din√°micamente -->
                    </div>
                    <div class="response-form">
                        <form onsubmit="addResponse(event, '{{ topic.id }}')">
                            <div class="form-group">
                                <label class="form-label">Tu respuesta:</label>
                                <textarea class="form-textarea" name="response_content" placeholder="Comparte tu conocimiento o experiencia..." required></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeTopic('{{ topic.id }}')">Cerrar</button>
                                <button type="submit" class="btn btn-primary">Responder</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            <p>No hay temas a√∫n. ¬°S√© el primero en crear uno!</p>
        </div>
        {% endfor %}
    </div>

    <!-- Floating Action Button -->
    <button class="fab" id="fabBtn" title="Nuevo tema">
        ‚úèÔ∏è
    </button>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/forum_interactive.js') }}"></script>
{% endblock %}
