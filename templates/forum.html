{% extends 'base.html' %}

{% block title %}VFORUM - Comunidad EEVI{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/forum_modern.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/forum_projects.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/solicitudes.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}">
<script>
document.addEventListener('DOMContentLoaded', () => {
    document.body.classList.add('forum-page');
});
</script>
{% endblock %}

{% block header %}<!-- Usar el header unificado de base.html -->{% endblock %}

{% block content %}
<div class="forum-layout">
    <!-- Sidebar Izquierda -->
    <aside class="sidebar-left">
        <div class="sidebar-title">Navegaci√≥n</div>
        <a href="{{ url_for('list_forum') }}" class="nav-item active">
            <div class="nav-icon">üè†</div>
            Inicio
        </a>
        {% if session.forum_user %}
        <a href="#" id="newTopicBtnSidebar" class="nav-item">
            <div class="nav-icon">‚úèÔ∏è</div>
            Nuevo Tema
        </a>
        {% else %}
        <a href="{{ url_for('forum_auth.vforum_auth') }}" class="nav-item">
            <div class="nav-icon">üîí</div>
            Inicia sesi√≥n
        </a>
        {% endif %}
        <a href="#" id="projectsBtn" class="nav-item">
            <div class="nav-icon">üöÄ</div>
            Buscar Proyectos
        </a>
        <a href="#" class="nav-item">
            <div class="nav-icon">üî•</div>
            Tendencias
        </a>
        <a href="#" class="nav-item">
            <div class="nav-icon">‚≠ê</div>
            Favoritos
        </a>
        <a href="#" class="nav-item">
            <div class="nav-icon">üë•</div>
            Miembros
        </a>

        <div class="sidebar-title" style="margin-top: var(--space-xl);">Tags Populares</div>
        <div class="tags-grid">
            <div class="tag-item">#grabaci√≥n</div>
            <div class="tag-item">#foley</div>
            <div class="tag-item">#mezcla</div>
            <div class="tag-item">#plugins</div>
            <div class="tag-item">#workflow</div>
            <div class="tag-item">#daw</div>
        </div>
    </aside>

    <!-- Contenido Principal -->
    <main class="main-content">
        <!-- Hero Section -->
        <section class="hero-section">
            <div class="hero-content">
                <h1 class="hero-title">√önete a VFORUM</h1>
                <p class="hero-subtitle">Conecta con creadores audiovisuales reales. Comparte conocimiento, resuelve problemas y colabora en proyectos √∫nicos.</p>
                {% if session.forum_user %}
                <button class="cta-button" id="newTopicBtn">
                    <span>‚úèÔ∏è</span>
                    Crear Tema
                </button>
                {% else %}
                <a href="{{ url_for('forum_auth.vforum_auth') }}" class="cta-button">
                    <span>üîí</span>
                    Inicia sesi√≥n para crear temas
                </a>
                {% endif %}
            </div>
        </section>

        <!-- Formulario Nuevo Tema -->
        <div class="new-topic-form" id="newTopicForm">
            <form id="topicForm" action="{{ url_for('create_new_forum') }}" method="post">
                <div class="form-group">
                    <label class="form-label" for="autor">Nombre:</label>
                    <input type="text" id="autor" name="autor" class="form-input" placeholder="Tu nombre" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="categoria">Categor√≠a:</label>
                    <select id="categoria" name="categoria" class="form-select" required>
                        <option value="">Selecciona una categor√≠a</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="titulo">T√≠tulo:</label>
                    <input type="text" id="titulo" name="titulo" class="form-input" placeholder="Un t√≠tulo descriptivo para tu tema" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="contenido">Contenido:</label>
                    <textarea id="contenido" name="contenido" class="form-textarea" placeholder="Describe tu problema, pregunta o comparte tu conocimiento..." required></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelBtn">Cancelar</button>
                    <button type="submit" class="cta-button">Publicar Tema</button>
                </div>
            </form>
        </div>

        <!-- Categor√≠as -->
        <section class="categories-section">
            <div class="section-header">
                <h2 class="section-title">Categor√≠as del Foro</h2>
                <div class="view-toggle">
                    <button class="toggle-btn active">Grid</button>
                    <button class="toggle-btn">Lista</button>
                </div>
            </div>

            <div class="categories-grid">
                {% set icon_map = {
                    'Grabaci√≥n en vivo': 'üé§',
                    'Dise√±o sonoro': 'üéµ',
                    'Foley y efectos': 'üîä',
                    'Edici√≥n de v√≠deo': 'üé¨',
                    'Mezcla y masterizaci√≥n': 'üéõÔ∏è',
                    'Workflows DAW y plugins': '‚öôÔ∏è'
                } %}
                {% set gradient_map = {
                    'Grabaci√≥n en vivo': '#EF4444, #F97316',
                    'Dise√±o sonoro': '#8B5CF6, #A855F7',
                    'Foley y efectos': '#10B981, #059669',
                    'Edici√≥n de v√≠deo': '#3B82F6, #1D4ED8',
                    'Mezcla y masterizaci√≥n': '#F59E0B, #D97706',
                    'Workflows DAW y plugins': '#6366F1, #4F46E5'
                } %}
                {% for cat in categories %}
                <div class="category-card" data-category="{{ cat }}">
                    <div class="category-header">
                        {% set grad = gradient_map.get(cat, '#6366F1, #4F46E5') %}
                        <div class="category-icon" style="background: linear-gradient(135deg, {{ grad }});">
                            {{ icon_map.get(cat, 'üéß') }}
                        </div>
                        <div class="category-info">
                            <div class="category-name">{{ cat }}</div>
                            <div class="category-description">&nbsp;</div>
                        </div>
                    </div>
                    <div class="category-stats">
                        <div class="stat-item">
                            <span>üí¨</span>
                            <span>{{ loop.index * 5 + 20 }} temas</span>
                        </div>
                        <div class="stat-item">
                            <span>üë•</span>
                            <span>{{ loop.index * 12 + 50 }} posts</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Temas Recientes -->
            <div style="margin-top: var(--space-2xl);">
                <h3 class="section-title">√öltimos temas</h3>
                <div class="topics-list" id="topicsList">
                    {% for topic in temas %}
                    <a href="{{ url_for('forum_topic_view', topic_id=topic.id) }}" class="topic-card" data-category="{{ topic.category }}">
                        <div class="topic-header">
                            <div class="topic-avatar">{{ (topic.author or topic.autor)[0].upper() if (topic.author or topic.autor) else 'A' }}</div>
                            <div class="topic-content">
                                <div class="topic-title">{{ topic.title or topic.titulo }}</div>
                                <div class="topic-meta">
                                    {% if topic.category %}
                                    <span class="topic-tag">{{ topic.category }}</span>
                                    <span>‚Ä¢</span>
                                    {% endif %}
                                    <span>{{ topic.author or topic.autor or 'An√≥nimo' }}</span>
                                    <span>‚Ä¢</span>
                                    <span>{{ (topic.created_at or topic.fecha or topic.timestamp) | timestamp_local }}</span>
                                </div>
                                <div class="topic-preview">{{ (topic.description or topic.contenido) | truncate_words(20) }}</div>
                            </div>
                        </div>
                    </a>
                    {% else %}
                    <div style="text-align:center; padding:2rem; color:var(--text-muted);">No hay temas a√∫n. ¬°S√© el primero en crear uno!</div>
                    {% endfor %}
                </div>
            </div>
        </section>
    </main>

    <!-- Sidebar Derecha -->
    <aside class="sidebar-right">
        <div class="widget">
            <div class="widget-title">
                <span>üü¢</span>
                Staff Online
            </div>
            <div class="user-list">
                {% for u in online_staff %}
                <div class="user-item">
                    <div class="user-avatar"></div>
                    <div class="user-info">
                        <div class="user-name">{{ u.id }}</div>
                        <div class="user-role">{{ u.role }}</div>
                    </div>
                    <div class="online-indicator"></div>
                </div>
                {% else %}
                <div class="user-item">No staff online</div>
                {% endfor %}
            </div>
        </div>
        <div class="widget">
            <div class="widget-title">
                <span>üìä</span>
                Estad√≠sticas
            </div>
            <div style="display:flex; flex-direction:column; gap:var(--space-md);">
                <div style="display:flex; justify-content:space-between;">
                    <span style="color:var(--text-secondary);">Total temas:</span>
                    <span style="font-weight:600;">{{ temas|length }}</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span style="color:var(--text-secondary);">Total posts:</span>
                    <span style="font-weight:600;">{{ temas|length * 3 }}</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span style="color:var(--text-secondary);">Miembros:</span>
                    <span style="font-weight:600;">89</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span style="color:var(--text-secondary);">Online ahora:</span>
                    <span style="font-weight:600; color:var(--success);">12</span>
                </div>
            </div>
        </div>
        <div class="widget">
            <div class="widget-title">
                <span>üî•</span>
                Trending
            </div>
            <div style="display:flex; flex-direction:column; gap:var(--space-md);">
                <div style="font-size:13px; color:var(--text-secondary); line-height:1.4;">
                    <strong style="color:var(--text-primary);">Grabaci√≥n en exteriores</strong><br>
                    T√©cnicas para eliminar ruido ambiente
                </div>
                <div style="font-size:13px; color:var(--text-secondary); line-height:1.4;">
                    <strong style="color:var(--text-primary);">Plugins de masterizaci√≥n</strong><br>
                    Comparativa de herramientas profesionales
                </div>
            <div style="font-size:13px; color:var(--text-secondary); line-height:1.4;">
                <strong style="color:var(--text-primary);">Workflow multic√°mara</strong><br>
                Sincronizaci√≥n eficiente de audio
            </div>
        </div>
        <div class="usuarios-conectados">
            <h3>Miembros Conectados</h3>
            <div id="usuarios-online-list">
                <div class="loading">Cargando usuarios...</div>
            </div>
        </div>
    </div>
    </aside>
    {% if session.forum_user %}
    <div class="user-status" style="position: fixed; bottom: 20px; right: 20px; background: var(--bg-secondary); padding: 1rem; border-radius: 12px;">
        <img src="{{ session.forum_user.profile_pic }}" alt="Avatar" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
        <span>{{ session.forum_user.username }}</span>
        <a href="{{ url_for('forum_auth.vforum_logout') }}" style="margin-left: 10px; color: var(--text-muted);">Salir</a>
    </div>
    {% endif %}
    <!-- Panel de Proyectos -->
    <div id="projectsPanel" class="projects-panel">
        <button class="close-projects-btn" id="closeProjectsBtn">
            <span>‚úï</span> Cerrar
        </button>
        
        <div class="projects-container">
            <!-- Header -->
            <div class="projects-header">
                <h1 class="projects-title">Proyectos Colaborativos</h1>
                <p class="projects-subtitle">
                    Encuentra colaboradores para tu proyecto audiovisual o √∫nete a proyectos en marcha
                </p>
                
                <!-- Controles -->
                <div class="projects-controls">
                    <div class="project-search">
                        <span class="project-search-icon">üîç</span>
                        <input type="text" class="project-search-input" 
                               placeholder="Buscar proyectos por t√≠tulo, categor√≠a o tags...">
                    </div>
                    <button class="project-filter-btn">
                        <span>‚öôÔ∏è</span> Filtros
                    </button>
                    {% if session.forum_user %}
                    <button class="project-new-btn" id="newProjectBtn">
                        <span>‚ûï</span> Crear Proyecto
                    </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- Grid de Proyectos -->
            <div class="projects-grid" id="projectsGrid">
                <!-- Los proyectos se cargar√°n din√°micamente -->
            </div>
        </div>
    </div>

    <!-- Modal Crear/Ver Proyecto -->
    <div id="projectModal" class="project-modal">
        <div class="project-modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Crear Nuevo Proyecto</h2>
                <button class="modal-close" id="closeModalBtn">‚úï</button>
            </div>
            
            <form id="projectForm" class="project-form">
                <div class="form-group">
                    <label class="form-label">T√≠tulo del Proyecto</label>
                    <input type="text" name="titulo" class="form-input" required 
                           placeholder="Ej: Documental sobre m√∫sica urbana">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Categor√≠a</label>
                        <select name="categoria" class="form-select" required>
                            <option value="">Selecciona...</option>
                            <option value="Cortometraje">Cortometraje</option>
                            <option value="Documental">Documental</option>
                            <option value="Videoclip">Videoclip</option>
                            <option value="Podcast">Podcast</option>
                            <option value="Serie Web">Serie Web</option>
                            <option value="Publicidad">Publicidad</option>
                            <option value="Videojuego">Videojuego</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="flex items-center gap-2">
                          Presupuesto en USD
                          <input type="checkbox" id="currency-switch" class="toggle">
                        </label>
                        <select id="presupuesto" class="form-select w-full"></select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea name="descripcion" class="form-textarea" rows="6" required 
                              placeholder="Describe tu proyecto: objetivos, estilo visual/sonoro, referencias, etc."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Duraci√≥n estimada</label>
                        <input type="text" name="duracion_estimada" class="form-input" 
                               placeholder="Ej: 2 semanas, 1 mes">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Profesiones requeridas</label>
                        <div id="roles-container" class="flex flex-col"></div>
                        <button type="button" id="add-role" class="text-emerald-400">+ A√±adir profesi√≥n</button>
                    </div>
                </div>
                
                <div class="form-group tag-input-container">
                    <label class="form-label">Tags (presiona Enter para agregar)</label>
                    <input type="text" id="tagInput" class="form-input" 
                           placeholder="Ej: indie, experimental, urbano">
                    <div class="tag-list" id="tagList"></div>
                    <input type="hidden" name="tags" id="tagsHidden">
                </div>
                
                <div class="form-actions" style="display: flex; gap: var(--space-md); justify-content: flex-end;">
                    <button type="button" class="btn-secondary" onclick="closeProjectModal()">
                        Cancelar
                    </button>
                    <button type="submit" class="cta-button">
                        Publicar Proyecto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ver Detalle Proyecto -->
    <div id="projectDetailModal" class="project-modal">
        <div class="project-modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="detailTitle">T√≠tulo del Proyecto</h2>
                <button class="modal-close" onclick="closeDetailModal()">‚úï</button>
            </div>
            
            <div id="projectDetailContent">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>
    {% include 'forum/chat_modal.html' %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/forum_modern.js') }}"></script>
<script src="{{ url_for('static', filename='js/forum_projects.js') }}"></script>
<script src="{{ url_for('static', filename='js/create_project.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_status.js') }}"></script>
<script src="{{ url_for('static', filename='js/solicitudes_manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/forum_transitions.js') }}"></script>
<script src="{{ url_for('static', filename='js/real_data_manager.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_status.css') }}">
{% if session.forum_user %}
<div data-user-id="{{ session.forum_user.id }}" style="display: none;"></div>
{% endif %}
{% endblock %}

