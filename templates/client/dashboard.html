{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="dashboard-container">
  {% if not user %}
  <p>Debes iniciar sesión.</p>
  {% else %}
  <h2>Mis Proyectos</h2>
  <div class="projects">
    {% for p in projects %}
    <div class="project-card">
      <h4>{{ p.title }}</h4>
      <iframe src="{{ p.embed_url }}" frameborder="0"></iframe>
      {% if p.status == 'closed' and not p.payment_validated %}
      <button class="pay" data-id="{{ p.id }}">Pagar</button>
      {% endif %}
      {% if p.payment_validated %}
      <a href="{{ url_for('download_project', project_id=p.id) }}">Descargar</a>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endblock %}
{% block scripts %}
<script>
  document.querySelectorAll('.pay').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const code=prompt('Ingresa código de pago');
      fetch(`/project/${btn.dataset.id}/payment/validate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})}).then(()=>location.reload());
    });
  });
</script>
{% endblock %}
